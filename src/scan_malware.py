import os
import csv
import hashlib
import zipfile

# CONFIGURATION
# Dynamic paths to work on both Docker and Local
SCRIPT_DIR = os.path.dirname(os.path.abspath(__file__))
PROJECT_ROOT = os.path.dirname(SCRIPT_DIR)
DATA_DIR = os.path.join(PROJECT_ROOT, "data")

MALWARE_DIR = os.path.join(DATA_DIR, "malware")
LABELS_FILE = os.path.join(DATA_DIR, "labels.csv")

def is_valid_ooxml(filepath):
    """Checks if the file is a valid ZIP archive (Magic Bytes 'PK')"""
    if not os.path.exists(filepath): return False
    try:
        with open(filepath, 'rb') as f:
            return f.read(2) == b'PK'
    except:
        return False

def calculate_sha256(filepath):
    sha256_hash = hashlib.sha256()
    with open(filepath, "rb") as f:
        for byte_block in iter(lambda: f.read(4096), b""):
            sha256_hash.update(byte_block)
    return sha256_hash.hexdigest()

def scan_and_log():
    print(f"[*] Scanning {MALWARE_DIR} for valid OOXML malware...")
    
    # 1. Ensure CSV exists with Headers
    if not os.path.exists(LABELS_FILE):
        with open(LABELS_FILE, 'w', newline='') as f:
            csv.writer(f).writerow(["sha256", "filename", "label", "source"])

    # 2. Read existing hashes to avoid duplicates
    existing_hashes = set()
    with open(LABELS_FILE, 'r') as f:
        reader = csv.DictReader(f)
        for row in reader:
            existing_hashes.add(row.get('sha256', ''))

    # 3. Iterate through files
    added_count = 0
    skipped_count = 0
    
    if not os.path.exists(MALWARE_DIR):
        print(f"[-] Error: {MALWARE_DIR} does not exist.")
        return

    with open(LABELS_FILE, 'a', newline='') as f:
        writer = csv.writer(f)
        
        for filename in os.listdir(MALWARE_DIR):
            filepath = os.path.join(MALWARE_DIR, filename)
            
            if os.path.isdir(filepath) or filename.startswith('.'):
                continue
            
            # --- THE CRITICAL CHECK ---
            if not is_valid_ooxml(filepath):
                print(f"    [SKIP] {filename} (Invalid Format/Not a Zip)")
                skipped_count += 1
                continue
            
            # Calculate Hash
            file_hash = calculate_sha256(filepath)
            
            if file_hash in existing_hashes:
                print(f"    [SKIP] {filename} (Already in CSV)")
                continue
            
            # Write to CSV
            writer.writerow([file_hash, filename, "Malicious", "Local_Scan"])
            print(f"    [ADDED] {filename}")
            added_count += 1

    print(f"\n[+] Done. Added {added_count} valid files. Skipped {skipped_count} invalid files.")

if __name__ == "__main__":
    scan_and_log()